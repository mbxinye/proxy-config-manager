name: Smart Proxy Config Updater

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š8ç‚¹è¿è¡Œ (UTC 00:00)
    - cron: '0 0 * * *'
  workflow_dispatch:
    inputs:
      force_full_test:
        description: 'å¼ºåˆ¶æµ‹è¯•æ‰€æœ‰è®¢é˜…'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  OUTPUT_DIR: 'output'
  PAGES_BRANCH: 'gh-pages'

jobs:
  update-proxy-config:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pyyaml aiohttp asyncio python-socks async_timeout
    
    - name: Load subscription database
      id: load-db
      run: |
        if [ -f data/subscriptions.json ]; then
          echo "Found existing subscription database"
          cat data/subscriptions.json | jq '.subscriptions | length' | xargs -I {} echo "subscription_count={}" >> $GITHUB_OUTPUT
        else
          echo "Creating new subscription database"
          echo "subscription_count=0" >> $GITHUB_OUTPUT
        fi
    
    - name: Initialize subscriptions from text file
      run: |
        python scripts/subscription_manager.py init
    
    - name: Select subscriptions to process
      id: select
      run: |
        SELECTED=$(python scripts/subscription_manager.py select)
        echo "Selected subscriptions: $SELECTED"
        echo "selected=$SELECTED" >> $GITHUB_OUTPUT
    
    - name: Fetch and merge subscriptions
      run: |
        python scripts/subscription_manager.py fetch
    
    - name: Validate nodes
      id: validate
      run: |
        python scripts/validator.py validate
        echo "total_nodes=$(cat output/validation_stats.json | jq '.total_nodes')" >> $GITHUB_OUTPUT
        echo "valid_nodes=$(cat output/validation_stats.json | jq '.valid_nodes')" >> $GITHUB_OUTPUT
    
    - name: Generate Clash configuration
      run: |
        python scripts/clash_generator.py generate
    
    - name: Update subscription scores
      run: |
        python scripts/subscription_manager.py update-scores
    
    - name: Generate summary report
      run: |
        python scripts/subscription_manager.py report > output/report.md
        cat output/report.md
    
    - name: Prepare GitHub Pages content
      run: |
        mkdir -p pages
        cp output/clash_config.yml pages/clash.yml
        cp output/clash_mini.yml pages/clash_mini.yml
        cp output/report.md pages/README.md
        
        # åˆ›å»ºç®€å•çš„HTMLç´¢å¼•é¡µ
        cat > pages/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <title>Smart Proxy Config</title>
          <style>
            body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
            h1 { color: #333; }
            .link-box { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
            .link-box a { color: #0066cc; text-decoration: none; font-size: 16px; }
            .link-box a:hover { text-decoration: underline; }
            .info { color: #666; font-size: 14px; margin-top: 5px; }
          </style>
        </head>
        <body>
          <h1>Smart Proxy Configuration</h1>
          <p>è‡ªåŠ¨æ›´æ–°çš„é«˜è´¨é‡ä»£ç†é…ç½®æ–‡ä»¶</p>
          
          <div class="link-box">
            <a href="./clash.yml">ğŸ“„ Clash å®Œæ•´é…ç½®</a>
            <div class="info">åŒ…å«50ä¸ªç²¾é€‰èŠ‚ç‚¹ï¼Œå®Œæ•´åˆ†æµè§„åˆ™</div>
          </div>
          
          <div class="link-box">
            <a href="./clash_mini.yml">ğŸ“„ Clash ç²¾ç®€é…ç½®</a>
            <div class="info">åŒ…å«20ä¸ªæœ€ä¼˜èŠ‚ç‚¹ï¼Œé€‚åˆç§»åŠ¨ç«¯</div>
          </div>
          
          <div class="link-box">
            <a href="./README.md">ğŸ“Š è¿è¡ŒæŠ¥å‘Š</a>
            <div class="info">æŸ¥çœ‹æœ¬æ¬¡æ›´æ–°çš„è¯¦ç»†ç»Ÿè®¡ä¿¡æ¯</div>
          </div>
          
          <hr>
          <p style="color: #999; font-size: 12px;">
            ä¸Šæ¬¡æ›´æ–°: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
          </p>
        </body>
        </html>
        EOF
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./pages
        publish_branch: ${{ env.PAGES_BRANCH }}
        force_orphan: true
    
    - name: Commit subscription database updates
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add data/subscriptions.json data/score_history.json
        git diff --cached --quiet || (git commit -m "Update subscription scores [$(date -u '+%Y-%m-%d')]" && git push)
    
    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: proxy-configs
        path: |
          output/clash_config.yml
          output/clash_mini.yml
          output/report.md
          output/validation_stats.json
        retention-days: 7
    
    - name: Summary
      run: |
        echo "## æ™ºèƒ½ä»£ç†é…ç½®æ›´æ–°å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“Š å¤„ç†äº†: ${{ steps.select.outputs.selected }} ä¸ªè®¢é˜…" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸŒ æ€»èŠ‚ç‚¹æ•°: ${{ steps.validate.outputs.total_nodes }}" >> $GITHUB_STEP_SUMMARY
        echo "- âœ… æœ‰æ•ˆèŠ‚ç‚¹: ${{ steps.validate.outputs.valid_nodes }}" >> $GITHUB_STEP_SUMMARY
        echo "- ğŸ“„ é…ç½®æ–‡ä»¶: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/clash.yml" >> $GITHUB_STEP_SUMMARY
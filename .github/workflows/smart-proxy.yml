name: Smart Proxy Config Updater - High Performance

on:
  schedule:
    # æ¯3å°æ—¶è¿è¡Œä¸€æ¬¡ (UTC 0, 3, 6, 9, 12, 15, 18, 21)
    - cron: '0 */3 * * *'
  workflow_dispatch:
    inputs:
      force_full_test:
        description: 'å¼ºåˆ¶æµ‹è¯•æ‰€æœ‰è®¢é˜…'
        required: false
        default: false
        type: boolean

env:
  PYTHON_VERSION: '3.11'
  OUTPUT_DIR: 'output'
  PAGES_BRANCH: 'gh-pages'
  # é«˜æ€§èƒ½æ¨¡å¼é…ç½®
  PROXY_BATCH_SIZE: '100'
  PROXY_BATCH_DELAY: '0.1'

jobs:
  update-proxy-config:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: ${{ env.PYTHON_VERSION }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pyyaml aiohttp asyncio python-socks async_timeout

    - name: Download and install Clash.Meta
      run: |
        echo "ğŸ“¥ ä¸‹è½½ Clash.Meta å†…æ ¸..."
        CLASH_VERSION=$(curl -s https://api.github.com/repos/MetaCubeX/mihomo/releases/latest | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/')
        echo "æœ€æ–°ç‰ˆæœ¬: $CLASH_VERSION"

        # ä¸‹è½½ Linux amd64 ç‰ˆæœ¬
        DOWNLOAD_URL="https://github.com/MetaCubeX/mihomo/releases/download/${CLASH_VERSION}/mihomo-linux-amd64-${CLASH_VERSION}.gz"
        echo "ä¸‹è½½åœ°å€: $DOWNLOAD_URL"

        curl -L -o clash.gz "$DOWNLOAD_URL"
        gunzip clash.gz
        chmod +x clash
        sudo mv clash /usr/local/bin/clash

        # éªŒè¯å®‰è£…
        echo "âœ“ Clash ç‰ˆæœ¬ä¿¡æ¯:"
        clash -v

    - name: Create directories
      run: mkdir -p output subscriptions data

    - name: Download existing subscription data from gh-pages
      run: |
        echo "ğŸ“¥ ä»gh-pagesåˆ†æ”¯ä¸‹è½½å†å²è¯„åˆ†æ•°æ®..."
        
        curl -sL "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/subscriptions.json" -o data/subscriptions.json.tmp
        if [ -s data/subscriptions.json.tmp ]; then
          mv data/subscriptions.json.tmp data/subscriptions.json
        else
          rm -f data/subscriptions.json.tmp
          echo "âš ï¸ æœªæ‰¾åˆ°å†å²è®¢é˜…æ•°æ®ï¼Œå°†åˆ›å»ºæ–°æ•°æ®åº“"
        fi
        
        curl -sL "https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/score_history.json" -o data/score_history.json.tmp
        if [ -s data/score_history.json.tmp ]; then
          mv data/score_history.json.tmp data/score_history.json
        else
          rm -f data/score_history.json.tmp
          echo "âš ï¸ æœªæ‰¾åˆ°å†å²è¯„åˆ†è®°å½•"
        fi
        
        echo "âœ“ æ•°æ®ä¸‹è½½å®Œæˆ"

    - name: Initialize subscriptions
      run: |
        echo "ğŸ“¦ åˆå§‹åŒ–è®¢é˜…æ•°æ®åº“..."
        python scripts/subscription_manager.py init
    
    - name: Select subscriptions
      id: select
      run: |
        echo "ğŸ¯ æ™ºèƒ½é€‰æ‹©è®¢é˜…..."
        SELECTED=$(python scripts/subscription_manager.py select)
        echo "selected_count=$(echo $SELECTED | jq '. | length')" >> $GITHUB_OUTPUT
        echo "Selected subscriptions: $SELECTED"
    
    - name: Fetch subscriptions (Parallel)
      run: |
        echo "ğŸ“¥ å¹¶è¡Œè·å–è®¢é˜…ï¼ˆå¤šçº¿ç¨‹ï¼‰..."
        python scripts/subscription_manager_fast.py
    
    - name: Validate nodes (TCP Test)
      id: validate
      run: |
        echo "ğŸ” ç¬¬ä¸€é˜¶æ®µï¼šTCPè¿é€šæ€§æµ‹è¯•..."
        python scripts/validator_fast.py

        # è¯»å–ç»Ÿè®¡
        if [ -f output/validation_stats.json ]; then
          echo "total_nodes=$(cat output/validation_stats.json | jq '.total_nodes')" >> $GITHUB_OUTPUT
        fi

    - name: Install Clash for real testing
      run: |
        echo "ğŸ”§ å®‰è£…Clashå†…æ ¸..."
        # ä¸‹è½½Clash.Meta (mihomo)
        CLASH_VERSION="v1.18.10"
        curl -sL "https://github.com/MetaCubeX/mihomo/releases/download/${CLASH_VERSION}/mihomo-linux-amd64-${CLASH_VERSION}.gz" -o clash.gz
        gunzip clash.gz
        chmod +x clash
        sudo mv clash /usr/local/bin/clash
        echo "âœ“ Clashå®‰è£…å®Œæˆ"
        clash -v

    - name: Test nodes with Clash (Real Proxy Test)
      id: clash_test
      run: |
        echo "ğŸ§ª ç¬¬äºŒé˜¶æ®µï¼šClashçœŸå®ä»£ç†æµ‹è¯•..."
        python scripts/clash_tester.py

        # è¯»å–Clashæµ‹è¯•ç»“æœ
        if [ -f output/clash_test_results.json ]; then
          echo "valid_nodes=$(cat output/clash_test_results.json | jq '.valid_nodes')" >> $GITHUB_OUTPUT
          echo "success_rate=$(cat output/clash_test_results.json | jq -r '.success_rate * 100 | round')" >> $GITHUB_OUTPUT
        fi
    
    - name: Update subscription scores
      run: |
        echo "ğŸ“Š æ›´æ–°è®¢é˜…è¯„åˆ†..."
        python scripts/subscription_manager.py update-scores
    
    - name: Generate Clash configuration
      run: |
        echo "ğŸ“ ç”ŸæˆClashé…ç½®ï¼ˆæ”¯æŒHysteria2/Tuic/anytlsç­‰åè®®ï¼‰..."
        python scripts/clash_generator.py generate
    
    - name: Generate report
      run: |
        echo "ğŸ“„ ç”ŸæˆæŠ¥å‘Š..."
        python scripts/subscription_manager.py report > output/report.md
        cat output/report.md
    
    - name: Prepare GitHub Pages
      run: |
        mkdir -p pages
        cp output/clash_config.yml pages/clash.yml
        cp output/clash_mini.yml pages/clash_mini.yml
        cp output/shadowrocket_nodes_full.txt pages/shadowrocket_full.txt
        cp output/shadowrocket_nodes_mini.txt pages/shadowrocket_mini.txt
        cp output/report.md pages/README.md
        # å¤åˆ¶è®¢é˜…è¯„åˆ†æ•°æ®åˆ°pagesåˆ†æ”¯
        cp data/subscriptions.json pages/subscriptions.json
        cp data/score_history.json pages/score_history.json
        echo "âœ“ å·²å¤åˆ¶è¯„åˆ†æ•°æ®åˆ°pagesç›®å½•"
        
        # åˆ›å»ºç´¢å¼•é¡µ
        cat > pages/index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
          <meta charset="UTF-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Smart Proxy Config</title>
          <style>
            body { 
              font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
              max-width: 800px; 
              margin: 50px auto; 
              padding: 20px; 
              background: #f5f5f5;
            }
            .container {
              background: white;
              padding: 30px;
              border-radius: 10px;
              box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            h1 { color: #333; border-bottom: 3px solid #4CAF50; padding-bottom: 10px; }
            .link-box { 
              background: #f9f9f9; 
              padding: 20px; 
              margin: 15px 0; 
              border-radius: 8px;
              border-left: 4px solid #4CAF50;
              transition: transform 0.2s;
            }
            .link-box:hover { transform: translateX(5px); }
            .link-box a { 
              color: #2196F3; 
              text-decoration: none; 
              font-size: 18px;
              font-weight: bold;
            }
            .link-box a:hover { text-decoration: underline; }
            .info { 
              color: #666; 
              font-size: 14px; 
              margin-top: 8px;
              line-height: 1.5;
            }
            .stats {
              background: #e3f2fd;
              padding: 15px;
              border-radius: 5px;
              margin: 20px 0;
            }
            .update-time {
              color: #999; 
              font-size: 12px;
              text-align: center;
              margin-top: 30px;
              padding-top: 20px;
              border-top: 1px solid #eee;
            }
          </style>
        </head>
        <body>
          <div class="container">
            <h1>ğŸš€ Smart Proxy Configuration</h1>
            <p>è‡ªåŠ¨æ›´æ–°çš„é«˜è´¨é‡ä»£ç†é…ç½®æ–‡ä»¶ï¼ˆé«˜æ€§èƒ½æ¨¡å¼ï¼‰</p>
            
            <div class="stats">
              <strong>ğŸ“Š ä¸Šæ¬¡æ›´æ–°ç»Ÿè®¡ï¼š</strong><br>
              æ€»èŠ‚ç‚¹: <span id="total">-</span> | 
              æœ‰æ•ˆèŠ‚ç‚¹: <span id="valid">-</span> | 
              æœ‰æ•ˆç‡: <span id="rate">-</span>%
            </div>
            
            <div class="link-box">
              <a href="./clash.yml">ğŸ“„ Clash å®Œæ•´é…ç½®</a>
              <div class="info">åŒ…å«50ä¸ªç²¾é€‰èŠ‚ç‚¹ï¼Œå®Œæ•´åˆ†æµè§„åˆ™ï¼Œé€‚ç”¨äº Clash/Shadowrocket</div>
            </div>
            
            <div class="link-box">
              <a href="./clash_mini.yml">ğŸ“„ Clash ç²¾ç®€é…ç½®</a>
              <div class="info">åŒ…å«20ä¸ªæœ€ä¼˜èŠ‚ç‚¹ï¼Œé€‚åˆç§»åŠ¨ç«¯ä½¿ç”¨</div>
            </div>
            
            <div class="link-box">
              <a href="./shadowrocket_full.txt">ğŸ“± Shadowrocket èŠ‚ç‚¹åˆ—è¡¨</a>
              <div class="info">50ä¸ªèŠ‚ç‚¹çš„ URI æ ¼å¼ï¼Œå¯ç›´æ¥å¤åˆ¶å¯¼å…¥ Shadowrocket</div>
            </div>
            
            <div class="link-box">
              <a href="./README.md">ğŸ“Š è¯¦ç»†æŠ¥å‘Š</a>
              <div class="info">æŸ¥çœ‹æœ¬æ¬¡æ›´æ–°çš„å®Œæ•´ç»Ÿè®¡ä¿¡æ¯å’Œè®¢é˜…è¯„åˆ†</div>
            </div>
            
            <div class="update-time">
              ä¸Šæ¬¡æ›´æ–°æ—¶é—´: <span id="time">Loading...</span><br>
              ä¸‹æ¬¡è‡ªåŠ¨æ›´æ–°: æ¯3å°æ—¶
            </div>
          </div>
          
          <script>
            document.getElementById('time').textContent = new Date().toLocaleString('zh-CN');
          </script>
        </body>
        </html>
        EOF
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./pages
        publish_branch: ${{ env.PAGES_BRANCH }}
        force_orphan: true

    - name: Upload artifacts
      uses: actions/upload-artifact@v4
      with:
        name: proxy-configs
        path: |
          output/clash_config.yml
          output/clash_mini.yml
          output/shadowrocket_nodes_full.txt
          output/shadowrocket_nodes_mini.txt
          output/report.md
          output/validation_stats.json
        retention-days: 7
    
    - name: Summary
      run: |
        echo "## ğŸš€ é«˜æ€§èƒ½ä»£ç†é…ç½®æ›´æ–°å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "| æŒ‡æ ‡ | æ•°å€¼ |" >> $GITHUB_STEP_SUMMARY
        echo "|------|------|" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ“Š å¤„ç†è®¢é˜… | ${{ steps.select.outputs.selected_count }} ä¸ª |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸŒ æ€»èŠ‚ç‚¹ | ${{ steps.validate.outputs.total_nodes }} |" >> $GITHUB_STEP_SUMMARY
        echo "| âœ… æœ‰æ•ˆèŠ‚ç‚¹ | ${{ steps.validate.outputs.valid_nodes }} |" >> $GITHUB_STEP_SUMMARY
        echo "| ğŸ“ˆ æœ‰æ•ˆç‡ | ${{ steps.validate.outputs.success_rate }}% |" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ğŸ“¥ é…ç½®æ–‡ä»¶ä¸‹è½½" >> $GITHUB_STEP_SUMMARY
        echo "- å®Œæ•´é…ç½®: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/clash.yml" >> $GITHUB_STEP_SUMMARY
        echo "- ç²¾ç®€é…ç½®: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/clash_mini.yml" >> $GITHUB_STEP_SUMMARY
        echo "- Shadowrocket: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/shadowrocket_full.txt" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âš¡ æ€§èƒ½æ¨¡å¼" >> $GITHUB_STEP_SUMMARY
        echo "- è®¢é˜…è·å–: 10çº¿ç¨‹å¹¶è¡Œ" >> $GITHUB_STEP_SUMMARY
        echo "- èŠ‚ç‚¹éªŒè¯: 100å¹¶å‘æµ‹è¯•" >> $GITHUB_STEP_SUMMARY